<script>
  /************************************************
   * FIREBASE INIT (ADMIN READ-ONLY)
   ************************************************/
  const firebaseConfig = {
    apiKey: "AIzaSyAJT61cprsH6Zxsv4xvubfMnKlk3XSq3gE",
    authDomain: "traffic-quiz-6eaa3.firebaseapp.com",
    projectId: "traffic-quiz-6eaa3",
    storageBucket: "traffic-quiz-6eaa3.firebasestorage.app",
    messagingSenderId: "1011063341314",
    appId: "1:1011063341314:web:2f4602a1dd1887d3b0821b"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  /************************************************
   * LOAD RESULTS (ROBUST)
   ************************************************/
  const table = document.getElementById("resultsTable");
  let count = 1;

  db.collection("results")
    .get() // ❗ removed orderBy to avoid type conflict
    .then(snapshot => {
      table.innerHTML = "";

      if (snapshot.empty) {
        table.innerHTML = `
          <tr>
            <td colspan="5" style="text-align:center;">
              No results found
            </td>
          </tr>
        `;
        return;
      }

      // sort manually by date (latest first)
      const docs = snapshot.docs.sort((a, b) => {
        const da = parseDate(a.data().createdAt);
        const db = parseDate(b.data().createdAt);
        return db - da;
      });

      docs.forEach(doc => {
        const d = doc.data();

        const dateObj = parseDate(d.createdAt);
        const dateText = dateObj
          ? dateObj.toLocaleString()
          : "—";

        const percentage = d.percentage !== undefined
          ? d.percentage + "%"
          : "—";

        const row = `
          <tr>
            <td>${count++}</td>
            <td>${d.name || "—"}</td>
            <td class="score">${d.score} / ${d.total}</td>
            <td>${percentage}</td>
            <td>${dateText}</td>
          </tr>
        `;

        table.innerHTML += row;
      });
    })
    .catch(error => {
      console.error("Admin Firestore error:", error);
      table.innerHTML = `
        <tr>
          <td colspan="5" style="text-align:center;color:red;">
            Failed to load results
          </td>
        </tr>
      `;
    });

  /************************************************
   * DATE PARSER (SUPPORTS ALL FORMATS)
   ************************************************/
  function parseDate(value) {
    if (!value) return null;

    // Firestore Timestamp
    if (typeof value.toDate === "function") {
      return value.toDate();
    }

    // ISO string
    if (typeof value === "string") {
      return new Date(value);
    }

    return null;
  }
</script>
